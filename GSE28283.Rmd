---
title: "R Notebook"
output: html_notebook
---
```{r setup}
    knitr::opts_knit$set(root.dir = normalizePath("/Users/helending/Documents/BCB330/raw/kidney")) 
```
# Library
```{r}
library(knitr)
library(limma)
library(ggplot2)
```

# Download GSE28283
* Experiment: find differential expression from AA, EA prostate cancer patients
```{r, results="hide"}

URL <- "https://www.ebi.ac.uk/arrayexpress/files/E-GEOD-28283"
SDRF.file <- "E-GEOD-28283.sdrf.txt"
Data.file <- "E-GEOD-28283.raw.1.zip"
if (! file.exists(SDRF.file)){
  download.file(paste(URL,SDRF.file,sep="/"), SDRF.file)
}
if (! file.exists(Data.file)){
  download.file(paste(URL,Data.file,sep="/"), Data.file)
  unzip(Data.file)
}
```

# Select only the normal samples
* 4 samples selected
```{r}
SDRF <- read.delim(SDRF.file,check.names=FALSE,stringsAsFactors=FALSE)

all_sample <- SDRF[,c("Array Data File","Comment [Sample_source_name]")]
# knitr::kable(all_sample[1:5,])
norm_ind <- which(SDRF$`Comment [Sample_source_name]` == "Renal cortex of normotensive male")
agilent_files <- grep(pattern="GeneView", SDRF[norm_ind, "Array Data File"], inv=T)
```

# Read Agilent files
* Data Cleaning: Removed bright and dark corner positive controls
```{r, results="hide", warning=FALSE}
read_data <- limma::read.maimages(files=SDRF[agilent_files, "Array Data File"], 
                          source="agilent", 
                          green.only=TRUE, 
                          other.columns = "gIsWellAboveBG")
```


# Inspect the data
```{r}
# ====================================== Plot 1 =======================================
# only neg control
read_data <- data.frame(read_data)
# View(read_data)
neg_ctrl_ind <- which(read_data$SystematicName == "NegativeControl")
read_data <- cbind("LABEL" = 1:nrow(read_data), read_data)
read_data$LABEL[neg_ctrl_ind] <- "negControl"
neg_ctrl <- read_data[neg_ctrl_ind, ]
rows <- nrow(neg_ctrl) # 288

# the rest
rest <- read_data[-neg_ctrl_ind,]
read_data$LABEL[which(read_data$LABEL != "negControl")] <- "rest"

rows <- nrow(rest) # 13449
cols <- ncol(rest) # 10

# Build plot: summarized
# View(read_data)
boxplot(read_data[, 7] ~ read_data$LABEL, ylab="Expression", xlab="labels")
for (i in 8:ncol(read_data)){
  boxplot(read_data[, i] ~ read_data$LABEL, ylab="Expression", xlab="labels", add=TRUE)
}

# ====================================== Plot 2 =======================================

# negative control with other species

# exclude human
human <- grep(pattern="hsa", read_data$SystematicName)
length(human) # 11569
read_data <- cbind("LABEL_OTHERS"=1:nrow(read_data), read_data)
read_data$LABEL_OTHERS[human] <- "human"

# exclude positive controls
pos_control <- which(read_data$ControlType == 1)
length(pos_control) # 281

# only non-human and neg control
neg_ctrl_with_other_spec <- read_data[-c(human, pos_control), ]
read_data$LABEL_OTHERS[which(read_data$LABEL_OTHERS != "human")] <- "rest (negControl+non-human)"

boxplot(read_data[, 8] ~ read_data$LABEL_OTHERS, col=c("red", "blue"))
for (i in 9:ncol(read_data)){
  boxplot(read_data[, i] ~ read_data$LABEL_OTHERS, col=c("red", "blue"), add=TRUE)
}
```
# find human miR
```{r}
human <- grep(pattern="hsa", read_data$SystematicName)
human_miR <- read_data[human,]
nrow(human_miR) # 13616
```

# Remove Bright and Dark Corners
```{r, results="hide", warning=FALSE}
# Remove Bright and Dark Corners
remove <- grep(pattern="Corner", read_data$SystematicName)
length(remove) # 41 brightCorner/darkCorner to be removed
read_data <- read_data[-remove, ]
nrow(read_data) # 15698
```

# Pick negative control
```{r}
y_neg_ctrl <- read_data[which(read_data$SystematicName == "NegativeControl"),]
y_neg_ctrl <- data.frame(y_neg_ctrl)


rows <- nrow(y_neg_ctrl) # 182
cols <- ncol(y_neg_ctrl) # 10

#View(y_neg_ctrl)
```

# Define expression threshold
### Find the n largest values and their position
```{r, results="hide"}
# top 1% 
n <- floor(rows * (cols-7) * 0.01) # 5
y_neg_ctrl <- as.matrix(y_neg_ctrl[,8:cols])
ncol(y_neg_ctrl) # 3

## Return n largest values and position for matrix m
nlargest <- function(m, n) {
  copy_m <- m
  copy_m <- as.vector(copy_m)
  res <- order(copy_m, decreasing=TRUE)[1:n]
  pos <- arrayInd(res, dim(m), useNames = TRUE)
  list(values = m[res],position = pos)
}
# expected: 5/3=1.66667
# inspect the top 1% values
greatest_0.01 <- nlargest(y_neg_ctrl, n)
selected_0.01 <- greatest_0.01$values
table(greatest_0.01$position[,2])
# 1 
# 5 
sd(greatest_0.01$position[,2]) # 0
thres <- min(greatest_0.01$values) # 69
```
# Define each miRNA expression
```{r}
# read in human mirna expression data
copy_y <- human_miR[,8:ncol(human_miR)]

# compare each expression value to thres
for(i in 1:nrow(copy_y)){
  for (j in 1:ncol(copy_y)){
    if (copy_y[i, j] >= thres){
      copy_y[i, j] <- 1
    } else{
      copy_y[i, j] <- 0
    }
  }
}

# sum the rows
copy_y <- cbind("SUM"=rowSums(copy_y), copy_y)
copy_y <- cbind("miR"=human_miR$SystematicName, copy_y)
rownames(copy_y) <- 1:nrow(copy_y)
```
## see if the negative controls are 1 or 0
```{r}
copy_y <- cbind("SystematicName"=human_miR$SystematicName, copy_y)
copy_y <- cbind("ControlType"=human_miR$ControlType, copy_y)
# View(copy_y)

# Select negative control
neg_control <- copy_y$SUM[which(copy_y$SystematicName == "NegativeControl")]
length(neg_control) # 182, all 0

# Select positive control
pos_control <- copy_y$SUM[which(copy_y$ControlType == 1)]
length(pos_control) # 240

# Select only human miR
human_mir <- copy_y[grep(pattern="hsa", copy_y$SystematicName),]
human_mir <- human_mir[, -c(1:2)]
rownames(human_mir) <- 1:nrow(human_mir)
View(human_mir)

# human mirna systematic names
human_mir_names <- copy_y$SystematicName[grep(pattern="hsa", copy_y$SystematicName)]
human_mir_names <- as.character(human_mir_names)
```

# save known
```{r}
final <- human_mir 
rownames(final) <- 1:nrow(final)

# change colnames to sample names
coln <- colnames(final)
coln <- gsub("^([^_]*)_([^_]*).*","\\1", coln)
colnames(final) <- coln

final <- data.frame(final)

length(unique(final$miR)) # 851
data <- final[which(duplicated(final$miR)),c(1:2)]
data <- data[order(data$miR),]

# previous names (with *)
ast <- data[grep('\\*', data$miR),]
nrow(ast) # 2565

# current names
data_curr <- data[-grep('\\*', data$miR),]
nrow(data_curr) # 10200

unique <- unique(data_curr$miR)
unique <- data.frame(unique)
nrow(unique) # 680
unique <- cbind(unique, "avg"= 0)
unique <- cbind(unique, "num_rep"=0)
colnames(unique)[1] <- "miR"

# inspect the sum for each duplicated miR
# UNIQUE ONES

for (i in 1:nrow(unique)){
  cnt = 0
  for (j in 1:nrow(data_curr)){
    if (identical(unique$miR[i], data_curr$miR[j])){
      cnt <- cnt + 1
      unique$avg[i] <- unique$avg[i] + data_curr$SUM[j]
    }
  }
  unique$avg[i] <- ceiling(unique$avg[i] / cnt)
  unique$num_rep[i] <- cnt
}
colnames(unique)[2] <- "kidney"
unique <- cbind(unique, "sample_num" = length(norm_ind))
```

# check novel or known miRNAs
```{r}
nc = MiRNANameConverter()
known_miR <- checkMiRNAName(nc, as.character(unique$miR), verbose = FALSE)
```
# save novel
```{r}
novel <- unique[which(unique$miR == "hsa-miR-1300_v13.0" | unique$miR == "hsa-miR-923_v12.0"), ]
rownames(novel) <- 1:nrow(novel)

# save
write.table(novel, "final_novel_no_ast_GSE28954.csv")
```

# save known
```{r}
known <- unique[-which(unique$miR %in% novel$miR),]
write.table(known, file="final_known_no_ast_GSE28954.csv")
```
